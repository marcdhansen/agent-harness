name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  validate:
    name: Test and Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run linter (Ruff)
        run: uv run ruff check .
        continue-on-error: true

      - name: Check formatting (Ruff)
        run: uv run ruff format --check .
        continue-on-error: true

      - name: Run tests (Pytest)
        run: uv run pytest tests/

      - name: Security scan (Bandit)
        run: uv run bandit -r src/ -ll

  beads-sync:
    name: Sync Beads
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: Install Beads
        run: |
          curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          bd --version || echo "Beads installation skipped"

      - name: Sync Beads
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          git fetch origin beads-metadata || true
          bd sync || echo "Beads sync failed - non-blocking"
        continue-on-error: true

      - name: Handle CI Failure
        if: failure()
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          EXISTING=$(bd list --label ci-failure --status open --json 2>/dev/null | jq 'length' || echo "0")
          
          if [ "$EXISTING" -eq 0 ]; then
            bd create "CI/CD Failure on main" -t bug -p 0 -l "ci-failure,automated" -d "CI/CD pipeline failed. See workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

      - name: Extract linked issues from commits
        if: success()
        id: extract_issues
        env:
          ISSUE_PATTERN: ${{ vars.BEADS_ISSUE_PATTERN || 'agent-[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)?(?:\.\d+)?' }}
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            const pattern = process.env.ISSUE_PATTERN;
            const issueRegex = new RegExp(pattern, 'gi');
            const issues = new Set();
            
            for (const commit of commits) {
              const matches = commit.message.match(issueRegex);
              if (matches) {
                matches.forEach(id => issues.add(id));
              }
            }
            return Array.from(issues);

      - name: Close issues on success
        if: success()
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          ISSUES='${{ steps.extract_issues.outputs.result }}'
          
          if [ "$ISSUES" != "[]" ] && [ -n "$ISSUES" ]; then
            echo "$ISSUES" | jq -r '.[]' | while read -r issue_id; do
              echo "Closing linked issue: $issue_id"
              bd close "$issue_id" --reason "CI/CD passed successfully [skip ci]" || true
            done
            bd sync || true
          fi

      - name: Commit and push beads updates
        if: always()
        env:
          BEADS_METADATA_BRANCH: "beads-metadata"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          if [ -d ".beads" ] && [ -n "$(git status --porcelain .beads/ 2>/dev/null)" ]; then
            mkdir -p /tmp/beads_backup
            cp -a .beads/ /tmp/beads_backup/
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin $BEADS_METADATA_BRANCH || true
            rm -f .beads/.migration-hint-ts .beads/.sync.lock .beads/daemon.lock .beads/daemon.pid .beads/daemon.log 2>/dev/null || true
            rm -rf .beads/
            if git show-ref --verify --quiet refs/remotes/origin/$BEADS_METADATA_BRANCH; then
              git checkout $BEADS_METADATA_BRANCH
              git pull origin $BEADS_METADATA_BRANCH
            else
              git checkout -b $BEADS_METADATA_BRANCH
            fi
            rm -rf .beads/
            cp -a /tmp/beads_backup/.beads/ .beads/
            rm -f .beads/beads.db .beads/beads.db-shm .beads/beads.db-wal
            rm -f .beads/.migration-hint-ts .beads/.sync.lock .beads/daemon.lock
            rm -f .beads/daemon.pid .beads/daemon.log
            git add .beads/
            if git commit -m "beads: auto-sync from CI [skip ci]"; then
              git push origin $BEADS_METADATA_BRANCH || echo "Push failed - non-blocking"
            fi
          fi
        continue-on-error: true
