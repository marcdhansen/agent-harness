name: Post-Merge CI

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write  # Requirement for gh issue create fallback

jobs:
  beads-automation:
    name: Sync Beads and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: '3.11'

      - name: Install dependencies
        run: |
          uv sync --all-extras --dev
          uv pip install bandit

      - name: Install Beads
        run: |
          # Download v0.50.3 directly (newer versions require Dolt which needs CGO)
          curl -sL https://github.com/steveyegge/beads/releases/download/v0.50.3/beads_0.50.3_linux_amd64.tar.gz -o /tmp/beads.tar.gz
          tar -xzf /tmp/beads.tar.gz -C /tmp
          chmod +x /tmp/beads_0.50.3_linux_amd64/beads
          mkdir -p "$HOME/.local/bin"
          mv /tmp/beads_0.50.3_linux_amd64/beads "$HOME/.local/bin/bd"
          rm -rf /tmp/beads*
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          bd version

      - name: Sync Beads
        id: sync
        run: |
          # CI uses JSONL-only mode (beads v0.50.3)
          export PATH="$HOME/.local/bin:$PATH"
          git fetch origin beads-metadata || true
          
          # Use --no-db mode since beads-metadata only has JSONL files
          if bd --no-db sync; then
            echo "Beads sync successful (JSONL mode)"
          else
            echo "::warning::Beads sync failed"
          fi
        continue-on-error: true

      - name: Run Safety Net Tests
        id: tests
        run: |
          uv run pytest tests/ -v --tb=short 2>&1 | tee pytest-output.txt
          echo "::group::Pytest Summary"
          cat pytest-output.txt | tail -20
          echo "::endgroup::"
        
      - name: Upload pytest logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-output
          path: pytest-output.txt
          
      - name: Show Python environment
        run: |
          echo "Python version: $(python --version)"
          echo "UV version: $(uv --version)"
          echo "Installed packages:"
          uv pip list | head -20
        
      - name: Security scan (Bandit)
        id: security
        run: |
          uv run bandit -r src/ -ll 2>&1 | tee bandit-output.txt
          echo "::group::Bandit Summary"
          cat bandit-output.txt | tail -10
          echo "::endgroup::"
        
      - name: Upload bandit logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-output
          path: bandit-output.txt

      - name: Handle CI Failure
        if: failure() || steps.sync.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -x
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "=== CI Failure Handler Debug ==="
          echo "Tests outcome: ${{ steps.tests.outcome }}"
          echo "Security outcome: ${{ steps.security.outcome }}"
          echo "Sync outcome: ${{ steps.sync.outcome }}"
          echo "bd available: $(command -v bd &> /dev/null && echo 'yes' || echo 'no')"
          
          # Check if beads is available
          if ! command -v bd &> /dev/null; then
            echo "::warning::Beads CLI not available. Creating GitHub issue as fallback."
            gh issue create \
              --title "ðŸš¨ [INFRA] Post-merge CI failure: Infrastructure/Install" \
              --body "The CI pipeline failed before Beads was installed or the Beads install itself failed.
              
              **Workflow:** ${{ github.workflow }}
              **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Commit:** ${{ github.sha }}
              **Triggered by:** @${{ github.actor }}
              
              *Note: This is an automated fallback issue because the 'bd' command was unavailable.*" \
              --label "ci-failure" --label "automated" --label "critical" || { ERROR_MSG=$(gh issue create --title "test" --body "test" 2>&1 || true); echo "::error::Failed to create GitHub issue fallback: $ERROR_MSG"; }
            exit 0
          fi

          # Normal Beads issue creation if bd is available
          EXISTING=$(bd list --label ci-failure --status open --json | jq 'length')
          
          if [ "$EXISTING" -eq 0 ]; then
            FAILED="Automated error detection: Job execution failed."
            [ "${{ steps.tests.outcome }}" = "failure" ] && FAILED="- Unit tests"
            [ "${{ steps.security.outcome }}" = "failure" ] && FAILED="- Security scan"
            [ "${{ steps.sync.outcome }}" = "failure" ] && FAILED="- Beads sync"

            bd create "ðŸš¨ CRITICAL: Post-merge CI failure on main" \
              -t bug -p 0 \
              -l "ci-failure" -l "automated" -l "critical" \
              -d "Post-merge CI pipeline failed. 
              
              **Failed checks:**
              $FAILED
              
              **Workflow:** ${{ github.workflow }}
              **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Commit:** ${{ github.sha }}
              **Triggered by:** @${{ github.actor }}

              Please investigate immediately."
          fi

      - name: Extract linked issues from commits
        if: steps.tests.outcome == 'success' && steps.security.outcome == 'success'
        id: extract_issues
        env:
          ISSUE_PATTERN: ${{ vars.BEADS_ISSUE_PATTERN || 'agent-[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)?(?:\.\d+)?' }}
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            const pattern = process.env.ISSUE_PATTERN;
            const issueRegex = new RegExp(pattern, 'gi');
            const issues = new Set();
            
            for (const commit of commits) {
              const matches = commit.message.match(issueRegex);
              if (matches) {
                matches.forEach(id => issues.add(id));
              }
            }
            return Array.from(issues);

      - name: Close issues on success
        if: steps.tests.outcome == 'success' && steps.security.outcome == 'success'
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          ISSUES='${{ steps.extract_issues.outputs.result }}'
          
          if [ "$ISSUES" != "[]" ]; then
            echo "Found issues to close: $ISSUES"
            echo "$ISSUES" | jq -r '.[]' | while read -r issue_id; do
              echo "Attempting to close issue: $issue_id"
              
              # Check if beads database exists
              if [ ! -d ".beads" ] || [ ! -f ".beads/beads.db" ]; then
                echo "::warning::No beads database found. Cannot close issue $issue_id."
                echo "::warning::Issue $issue_id needs manual closure."
                continue
              fi
              
              # Try to close the issue
              if bd close "$issue_id" --reason "âœ… CI/CD passed successfully [skip ci]"; then
                echo "Successfully closed issue: $issue_id"
              else
                echo "::warning::Failed to close issue $issue_id"
                echo "::warning::Issue $issue_id may need manual closure"
              fi
            done
            bd sync || echo "::warning::Final sync failed"
          else
            echo "No issues found in commit messages to close"
          fi

      - name: Commit and push beads updates
        if: always()
        env:
          BEADS_METADATA_BRANCH: "beads-metadata"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          if [ -d ".beads" ] && [ -n "$(git status --porcelain .beads/ 2>/dev/null)" ]; then
            echo "Beads changes detected. Moving to metadata branch..."
            
            # Save current beads state robustly
            mkdir -p /tmp/beads_backup
            cp -a .beads/ /tmp/beads_backup/
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Fetch metadata branch
            git fetch origin $BEADS_METADATA_BRANCH || true
            
            # CRITICAL: Remove .beads and ALL artifacts before checkout to avoid conflicts
            rm -f .beads/.migration-hint-ts .beads/.sync.lock .beads/daemon.lock .beads/daemon.pid .beads/daemon.log 2>/dev/null || true
            rm -rf .beads/
            
            if git show-ref --verify --quiet refs/remotes/origin/$BEADS_METADATA_BRANCH; then
              git checkout $BEADS_METADATA_BRANCH
              git pull origin $BEADS_METADATA_BRANCH
            else
              git checkout -b $BEADS_METADATA_BRANCH
            fi
            
            # Restore saved beads state and clean up ALL runtime artifacts
            rm -rf .beads/
            cp -a /tmp/beads_backup/.beads/ .beads/
            # Remove ALL runtime/temporary artifacts that shouldn't be committed
            rm -f .beads/beads.db .beads/beads.db-shm .beads/beads.db-wal
            rm -f .beads/.migration-hint-ts .beads/.sync.lock .beads/daemon.lock
            rm -f .beads/daemon.pid .beads/daemon.log
            
            git add .beads/
            if git commit -m "beads: auto-sync from post-merge CI [skip ci]"; then
              git push origin $BEADS_METADATA_BRANCH
            else
              echo "No changes to commit in .beads after restore."
            fi
          fi
